#!/usr/bin/env bash

# REF: # I used this to get started with Web Scraping
#https://data36.com/web-scraping-tutorial-episode-1-scraping-a-webpage-with-bash/. ./lib/webscraper || true

. ./lib/webscraper || true

# Functions
clean_cache() {
	local CLEANED=$1
	local GAMEFILE=$2
	local RAW_TEXT=$3
	local RAW_HTML=$4
	:
	# Remove all cached files
	if [[ $DEBUG -eq 0 ]]; then
		rm -f "${CLEANED}"
		rm -f "${GAMEFILE}"* # Delete the individual game files
		rm -f "${RAW_TEXT}"  # Delete the raw text file
		rm -f "${RAW_HTML}"  # Delete the raw html file
	fi
}

# Main
main() {
	# Variable Def's
	# It would be nice if these were all in a config file, but this is just a quick script, so here we are.
	local URL="https://www.nhl.com/news/nhl-lineup-projections-2025-26-season"
	## We should use this to make the script more portable, but for now, we'll just use the home directory for caching
	local SCRIPT_DIR="$(dirname "$(readlink -f "$0")")" 
	local CACHE="${SCRIPT_DIR}/.cache/nhl_lineup" # "base" location for all temp files
	local RAW_HTML="${SCRIPT_DIR}/.cache/nhl_lineup/nhl_lineup.html"   # Pure HTML
	local RAW_TEXT="${SCRIPT_DIR}/.cache/nhl_lineup/nhl_lineup.txt"    # HTML removed
	local GAMEFILE="${SCRIPT_DIR}/.cache/nhl_lineup/game-"
	# All the schedules in text format, no htmi, no header or footer
	local CLEANED="${CACHE}/nhl_lineup.cleaned"
	local HTMLFILE="${HOME}/bin/nhl_lineup.html" # DEBUG
	local SHOW_SCHEDULE=0
	local PUBLISHED_DATE="" # Date the HTML Page was Published
	local DEBUG=0           # -d to enable debugging
	# set -- "-d" "DET"	# DEBUGging w/in VSCODE
	# Associative array [team abbreviation]"team name"
	declare -A teams_long=(
	["COL"]="AVALANCHE"
	["CHI"]="BLACKHAWKS"
	["CBJ"]="BLUE JACKETS"
	["STL"]="BLUES"
	["BOS"]="BRUINS"
	["MTL"]="CANADIENS"
	["VAN"]="CANUCKS"
	["WSH"]="CAPITALS"
	["NJD"]="DEVILS"
	["ANA"]="DUCKS"
	["CGY"]="FLAMES"
	["PHI"]="FLYERS"
	["VGK"]="GOLDEN KNIGHTS"
	["CAR"]="HURRICANES"
	["NYI"]="ISLANDERS"
	["WPG"]="JETS"
	["LAK"]="KINGS"
	["SEA"]="KRAKEN"
	["TBL"]="LIGHTNING"
	["TOR"]="MAPLE LEAFS"
	["UTA"]="MAMMOTH"
	["EDM"]="OILERS"
	["FLA"]="PANTHERS"
	["PIT"]="PENGUINS"
	["NSH"]="PREDATORS"
	["DET"]="RED WINGS"
	["NYR"]="RANGERS"
	["BUF"]="SABRES"
	["OTT"]="SENATORS"
	["SJS"]="SHARKS"
	["DAL"]="STARS"
	["MIN"]="WILD"
	)
	clear

	check_depends "${CACHE}" # Are the necessary files installed / available?
	status=$?
	case $status in
	1)	# Check if html2text is installed
		echo "html2text not installed. sudo apt install html2text"
		exit 1
		;;
	2)	# Check if curl is installed
		echo "curl not installed. sudo apt install curl"
		exit 1
		;;
	3)	# BASH version check, we need version 4 or higher for mapfile
		echo "mapfile not found. Requires bash version 4 or higher."
		exit 1
		;;
	4)	# If the chache directory doesn't exist, create it
		mkdir -p "${CACHE}"
		;;
	*) ;;
	esac

	# Check if NO args where provided, show usage.
	if [[ $# -eq 0 ]]; then
		declare -p teams_long >/dev/null 2>&1 # Ensure the array exists
		print_usage teams_long
	fi

	# Parse all command line options
	while getopts "hsd" opt; do
		case $opt in
		h)
			declare -p teams_long >/dev/null 2>&1 # Ensure the array exists
			print_usage teams_long
			;;
		s)
			SHOW_SCHEDULE=1 # Set a flag so we know to show the schedule
			;;
		d)
			DEBUG=1
			;;
		*)
			declare -p teams_long >/dev/null 2>&1 # Ensure the array exists
			print_usage teams_long
			;;
		esac
	done
	shift $((OPTIND - 1))

	debug "${DEBUG} getopts" # DEBUG

	# Curl HTML file
	get_htmlfile "${URL}" "${RAW_HTML}" "${DEBUG}" "${HTMLFILE}"

	# Convert HTML file to Text file
	html_to_text "${RAW_HTML}" "${RAW_TEXT}" 

	# Pull html published date from w/in the HTML File
	PUBLISHED_DATE=$(get_HTML_date "$RAW_TEXT")

	debug "Published Date: ${PUBLISHED_DATE}" # DEBUG

	# Skip this check if we're debugging, we may be using an old HTML file
	if [[ $DEBUG -eq 0 ]]; then 
		check_date "$PUBLISHED_DATE";
		status=$?
		if [[ $status -eq 1 ]]; then
			echo ""
			echo " No games currently scheduled for today."
			echo ""
			clean_cache "${CLEANED}" "${GAMEFILE}" "${RAW_TEXT}" "${RAW_HTML}"
			exit 0
		fi # Compare date in file with today's date
	fi

	# Remove header and footer from text file
	remove_headers "${RAW_TEXT}" "${CLEANED}"

	# Show the schedule
	if [[ ${SHOW_SCHEDULE} -eq 1 ]]; then
		print_schedule "${CLEANED}"

	# Show the lineup for the requested team
	else
		# make 1 game file per scheduled game
		make_game_files "${CLEANED}" "${GAMEFILE}"

		# Remove Status Report section from game files
		remove_status_report "${CLEANED}"

		# Resolve the team name from abbreviation or full name
		tm=$(resolve_team_name "$1")

		# Check if team was found (0 means invalid/misspelled)
		if [[ "${tm}" == "0" ]]; then
			echo
			echo "Team not found: '$1'. Please check the spelling or use -h for available teams."
			echo
		else
			game=$(find_gamefile "${tm}")

			if [[ ${game} ]]; then
				print_game_info "${game}" "${tm}"
			else
				echo
				echo "${tm} are not playing today."
				echo
			fi
		fi
	fi

	exit 0
}

main "$@"
