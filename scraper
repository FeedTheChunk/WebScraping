#!/usr/bin/env bash
#
# Thanks to Dave Eddy over at YSAP.  I've learned a lot from his videos
# If you haven't checked him out, I recommend you give him a view.
#
# REF: # I used this to get started with learning Web Scraping
# https://data36.com/web-scraping-tutorial-episode-1-scraping-a-webpage-with-bash/
#
# Load the helper functions
. ./lib/webscraper || true

# Main
main() {
	# Variable Def's
	# This years projected lineup
	local url="https://www.nhl.com/news/nhl-lineup-projections-2025-26-season"
	local script_dir="$(dirname "$(readlink -f "$0")")" 
	local htmlfile="${script_dir}/nhl_lineup.html" # html file used for debugging
	local cache="${script_dir}/.cache/nhl_lineup" # "base" location for all temp files
	local raw_html="${cache}/nhl_lineup.html"   # Pure HTML
	local raw_text="${cache}/nhl_lineup.txt"    # HTML removed
	local gamefile="${cache}/game-"
	local cleaned="${cache}/nhl_lineup.cleaned" # All the schedules in text format
	local show_schedule=0	# Show tpday's schedule
	local published_date="" # Date the HTML Page was Published
	local DEBUG=0           # -d to enable debugging
	
	# Associative array [team abbreviation] ["team name"]
	declare -A teams_long=(
	["COL"]="AVALANCHE"
	["CHI"]="BLACKHAWKS"
	["CBJ"]="BLUE JACKETS"
	["STL"]="BLUES"
	["BOS"]="BRUINS"
	["MTL"]="CANADIENS"
	["VAN"]="CANUCKS"
	["WSH"]="CAPITALS"
	["NJD"]="DEVILS"
	["ANA"]="DUCKS"
	["CGY"]="FLAMES"
	["PHI"]="FLYERS"
	["VGK"]="GOLDEN KNIGHTS"
	["CAR"]="HURRICANES"
	["NYI"]="ISLANDERS"
	["WPG"]="JETS"
	["LAK"]="KINGS"
	["SEA"]="KRAKEN"
	["TBL"]="LIGHTNING"
	["TOR"]="MAPLE LEAFS"
	["UTA"]="MAMMOTH"
	["EDM"]="OILERS"
	["FLA"]="PANTHERS"
	["PIT"]="PENGUINS"
	["NSH"]="PREDATORS"
	["DET"]="RED WINGS"
	["NYR"]="RANGERS"
	["BUF"]="SABRES"
	["OTT"]="SENATORS"
	["SJS"]="SHARKS"
	["DAL"]="STARS"
	["MIN"]="WILD"
	)
	clear
	
	# DEBUGging w/in VSCODE
	# set -- "-d" "DET"

	# Are the necessary files installed / available?
	check_depends "${cache}" 
	status=$?
	case $status in
	1)	# Check if html2text is installed
		echo "html2text not installed. sudo apt install html2text"
		exit 1
		;;
	2)	# Check if curl is installed
		echo "curl not installed. sudo apt install curl"
		exit 1
		;;
	3)	# BASH version check, we need version 4 or higher for mapfile
		echo "mapfile not found. Requires bash version 4 or higher."
		exit 1
		;;
	4)	# If the chache directory doesn't exist, create it
		mkdir -p "${cache}"
		;;
	*) ;;
	esac

	# Check if NO args where provided, show usage.
	if [[ $# -eq 0 ]]; then
		declare -p teams_long >/dev/null 2>&1 # Ensure the array exists
		print_usage teams_long
	fi

	# Parse all command line options
	while getopts "hsd" opt; do
		case $opt in
		h)	#print help / usage
			declare -p teams_long >/dev/null 2>&1 # Ensure the array exists
			print_usage teams_long
			;;
		s)	# Show today's schedule
			show_schedule=1 # Set a flag so we know to show the schedule
			;;
		d)	# Debugging enabled
			DEBUG=1
			;;
		*)	#print help / usage
			declare -p teams_long >/dev/null 2>&1 # Ensure the array exists
			print_usage teams_long
			;;
		esac
	done
	shift $((OPTIND - 1))

	debug "[main] ${DEBUG} getopts" # DEBUG

	# Curl HTML file
	get_htmlfile "${url}" "${raw_html}" "${DEBUG}" "${htmlfile}"

	# Convert HTML file to Text file
	html_to_text "${raw_html}" "${raw_text}" 

	# Pull html published date from w/in the HTML File
	published_date=$(get_HTML_date "$raw_text")

	debug "Published Date: ${published_date}" # DEBUG

	# Skip this check if we're debugging, we may be using an old HTML file
	if [[ $DEBUG -eq 0 ]]; then 
		check_date "$published_date";
		status=$?
		if [[ $status -eq 1 ]]; then
			echo ""
			echo " No games currently scheduled for today."
			echo ""
			clean_cache "${cleaned}" "${gamefile}" "${raw_text}" "${raw_html}"
			exit 0
		fi # Compare date in file with today's date
	fi

	# Remove header and footer from text file
	remove_headers "${raw_text}" "${cleaned}"
	debug "Removed headers and footers from text file." # DEBUG

	# Show the schedule
	if [[ ${show_schedule} -eq 1 ]]; then
		print_schedule "${cleaned}"
		debug "Printed schedule." # DEBUG
	# Show the lineup for the requested team
	else
		# make 1 game file per scheduled game
		make_game_files "${cleaned}" "${gamefile}"
		debug "Created game files." # DEBUG
		# Remove Status Report section from game files
		remove_status_report "${cleaned}"
		debug "Removed status report section from game files." # DEBUG
		# Resolve the team name from abbreviation or full name
		tm=$(resolve_team_name "$1")
		debug "Resolved team name: ${tm}" # DEBUG
		# Check if team was found (0 means invalid/misspelled)
		if [[ "${tm}" == "0" ]]; then
			echo
			echo "Team not found: '$1'. Please check the spelling or use -h for available teams."
			echo
		else
			# find_gamefile "${tm}" "${gamefile}"
			
			local game=$(find_gamefile "${tm}" "${gamefile}")

			debug "Found game file for game: ${game}" # DEBUG
			if [[ ${game} ]]; then
				debug "Printing game info for team: ${tm} from file: ${game}" # DEBUG

				print_game_info "${game}" "${tm}"
			else
				echo
				echo "${tm} are not playing today."
				echo
			fi
		fi
	fi

	exit 0
}

main "$@"
